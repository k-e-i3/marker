<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éá„Ç∏„Çø„É´„Éª„Éû„Éº„Ç´„ÉºÂºèÊöóË®ò„ÉÑ„Éº„É´ v3.2</title>
    <style>
        :root {
            --bg-color: #f4f4f9; --main-bg: #ffffff; --rule-bg: #eef1f5;
            --text-color: #333; --border-color: #d1d9e6; --header-bg: #2d3748;
            --header-text: #ffffff; --button-bg: #4a5568; --button-hover-bg: #2d3748;
            --highlight-bg: #fffde7; --speech-highlight-bg: #fdff32;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', 'Noto Sans CJK JP', sans-serif;
            margin: 0; background-color: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        header {
            background-color: var(--header-bg); color: var(--header-text); padding: 10px 15px;
            display: flex; align-items: center; flex-wrap: wrap; gap: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; z-index: 10;
        }
        header h1 { font-size: 1.1em; margin: 0; }
        .control-group { display: flex; align-items: center; gap: 5px; }
        select, input, button {
            font-size: 14px; padding: 6px 12px; border-radius: 5px;
            border: 1px solid #718096; background-color: #edf2f7; color: #2d3748;
        }
        button {
            background-color: var(--button-bg); color: var(--header-text); cursor: pointer;
            border-color: transparent; transition: background-color 0.2s;
        }
        button:hover { background-color: var(--button-hover-bg); }
        label { display: flex; align-items: center; gap: 4px; cursor: pointer; user-select: none; }
        main {
            display: flex; flex-direction: column; flex-grow: 1;
            padding: 15px; gap: 15px; overflow: hidden; position: relative;
        }
        .panel {
            background-color: var(--main-bg); border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border-color);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .panel.main { flex-grow: 1; position: relative; }
        .panel.manager { flex-shrink: 0; height: 200px; transition: height 0.3s ease, opacity 0.3s; }
        .panel.manager.closed { height: 42px; }
        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; border-bottom: 1px solid var(--border-color);
            background-color: #f9fafb; cursor: pointer; user-select: none;
        }
        .panel-header h2 { font-size: 1em; margin: 0; }
        .panel-header-controls { display: flex; align-items: center; gap: 10px; }
        #main-text-area {
            flex-grow: 1; padding: 15px; font-size: 18px; line-height: 1.8;
            white-space: pre-wrap; word-wrap: break-word; overflow-y: auto; outline: none;
        }
        .markers-hidden #main-text-area .marker {
            background-color: transparent !important;
            color: var(--text-color) !important;
            letter-spacing: normal !important;
        }
        #marker-manager-list { overflow-y: auto; padding: 10px; }
        .manager-item {
            display: flex; align-items: center; padding: 8px;
            border-bottom: 1px solid #e2e8f0; font-size: 14px;
            cursor: pointer; transition: background-color 0.2s;
        }
        .manager-item:hover { background-color: #f7fafc; }
        .manager-item-icon { font-size: 1.2em; min-width: 30px; text-align: center; }
        .manager-item-text { flex-grow: 1; font-weight: bold; color: #2d3748; }
        .manager-item-context { color: #718096; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .manager-item-delete {
            background: none; border: none; font-size: 1.2em; cursor: pointer;
            color: #a0aec0; transition: color 0.2s; padding: 5px;
        }
        .manager-item-delete:hover { color: #e53e3e; }

        .marker { cursor: pointer; border-radius: 3px; user-select: none; letter-spacing: 0.05em; }
        .marker.reveal { background-color: var(--highlight-bg); letter-spacing: normal; }
        .marker.jump-highlight { animation: jump-highlight 1.5s ease; }
        @keyframes jump-highlight { 0% { background-color: #f6e05e; } 100% { background-color: transparent; } }

        #mini-palette {
            position: absolute; background-color: #333; padding: 8px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: none; gap: 5px; z-index: 100;
        }
        .mini-palette-item {
            width: 32px; height: 32px; cursor: pointer; border: 2px solid transparent; border-radius: 6px;
            display: flex; justify-content: center; align-items: center; font-size: 22px; transition: transform 0.1s;
        }
        .mini-palette-item:hover { transform: scale(1.15); background-color: #555; }

        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fff; padding: 20px; border-radius: 8px;
            width: 80%; max-width: 700px; display: flex;
            flex-direction: column; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .modal-content textarea { height: 40vh; border: 1px solid #ccc; font-family: monospace; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .modal-choices { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        .modal-choices button { padding: 10px 20px; font-size: 16px; }

        .speech-highlight { background-color: var(--speech-highlight-bg); border-radius: 3px; }
    </style>
</head>
<body>
    <header>
        <h1>„Éû„Éº„Ç´„ÉºÂºèÊöóË®ò„ÉÑ„Éº„É´ v3.2</h1>
        <div class="control-group">
            <select id="doc-select"></select>
            <button id="rename-doc-btn" title="„Çø„Ç§„Éà„É´„ÇíÁ∑®ÈõÜ">üìù</button>
        </div>
        <div class="control-group">
            <span id="char-counter" style="min-width: 100px;">ÊñáÂ≠óÊï∞: 0</span>
        </div>
        <div class="control-group">
            <label><input type="checkbox" id="toggle-markers-cb" checked> „Éû„Éº„Ç´„ÉºË°®Á§∫</label>
        </div>
        <div class="control-group">
            <button id="speech-btn">‚ñ∂ Ë™≠„Åø‰∏ä„Åí</button>
            <select id="voice-select"></select>
        </div>
        <div class="control-group">
            <button id="copy-text-btn">üìÑ ÂéüÊñá„Ç≥„Éî„Éº</button>
            <button id="sync-btn">üîÑ ÂÖ®„Éá„Éº„ÇøÂêåÊúü</button>
        </div>
    </header>

    <main id="main-container">
        <div id="mini-palette"></div>
        <div class="panel main">
            <div id="main-text-area" contenteditable="true" spellcheck="false"></div>
        </div>
        <div class="panel manager" id="manager-panel">
            <div class="panel-header" id="manager-header">
                <h2>„Éû„Éº„Ç´„Éº„Éª„Éû„Éç„Éº„Ç∏„É£„Éº</h2>
                <div class="panel-header-controls">
                    <button id="copy-rules-btn" title="„Åì„ÅÆÊñáÁ´†„ÅÆ„Éû„Éº„Ç´„Éº„É´„Éº„É´„Çí„Ç≥„Éî„Éº">„Ç≥„Éî„Éº</button>
                    <button id="import-rules-btn" title="„Åì„ÅÆÊñáÁ´†„Å´„Éû„Éº„Ç´„Éº„É´„Éº„É´„Çí„Ç§„É≥„Éù„Éº„Éà">„Ç§„É≥„Éù„Éº„Éà</button>
                    <span id="toggle-manager-btn">‚ñº Èñâ„Åò„Çã</span>
                </div>
            </div>
            <div id="marker-manager-list"></div>
        </div>
    </main>
    
    <div id="modal-overlay">
        <div class="modal-content" id="sync-modal">
            <h3 id="modal-title"></h3>
            <div id="modal-choices" class="modal-choices">
                 <button id="export-choice-btn">„Ç®„ÇØ„Çπ„Éù„Éº„Éà („Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàê)</button>
                 <button id="import-choice-btn">„Ç§„É≥„Éù„Éº„Éà („Éá„Éº„ÇøÂæ©ÂÖÉ)</button>
            </div>
            <p id="modal-desc"></p>
            <textarea id="io-textarea"></textarea>
            <div class="modal-buttons">
                <button id="io-action-btn"></button>
                <button id="close-modal-btn">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <script>
    class MarkerToolV3_2 {
        constructor() {
            // DOM Elements
            this.docSelect = document.getElementById('doc-select');
            this.renameDocBtn = document.getElementById('rename-doc-btn');
            this.mainTextArea = document.getElementById('main-text-area');
            this.markerManagerList = document.getElementById('marker-manager-list');
            this.charCounter = document.getElementById('char-counter');
            this.speechBtn = document.getElementById('speech-btn');
            this.voiceSelect = document.getElementById('voice-select');
            this.managerPanel = document.getElementById('manager-panel');
            this.managerHeader = document.getElementById('manager-header');
            this.toggleManagerBtn = document.getElementById('toggle-manager-btn');
            this.miniPalette = document.getElementById('mini-palette');
            this.copyTextBtn = document.getElementById('copy-text-btn');
            this.syncBtn = document.getElementById('sync-btn');
            this.toggleMarkersCb = document.getElementById('toggle-markers-cb');
            this.mainContainer = document.getElementById('main-container');
            this.copyRulesBtn = document.getElementById('copy-rules-btn');
            this.importRulesBtn = document.getElementById('import-rules-btn');
            this.modalOverlay = document.getElementById('modal-overlay');
            this.modalTitle = document.getElementById('modal-title');
            this.modalDesc = document.getElementById('modal-desc');
            this.modalChoices = document.getElementById('modal-choices');
            this.ioTextarea = document.getElementById('io-textarea');
            this.ioActionBtn = document.getElementById('io-action-btn');
            this.closeModalBtn = document.getElementById('close-modal-btn');
            this.exportChoiceBtn = document.getElementById('export-choice-btn');
            this.importChoiceBtn = document.getElementById('import-choice-btn');
            
            this.markerStyles = [
                { type: 'E', value: 'üêû' }, { type: 'E', value: 'üêô' }, { type: 'E', value: 'üòÄ' },
                { type: 'E', value: 'üê∏' }, { type: 'E', value: 'üëΩ' }, { type: 'E', value: 'üßü‚Äç‚ôÄÔ∏è' },
                { type: 'E', value: 'ü•∂' }, { type: 'E', value: 'üåè' }, { type: 'E', value: 'üí©' },
                { type: 'E', value: 'üçá' }, { type: 'E', value: 'üèÄ' }
            ];

            this.state = {
                anchorLength: 10, isSpeaking: false, voices: [], appData: {},
                currentDocIndex: 0, selectionRange: null, lastTapTime: 0, lastTapTarget: null,
            };
            
            this.DOC_COUNT = 20;
            this.init();
        }

        init() {
            this.createMiniPalette();
            this.loadState();
            this.initSpeech();
            this.bindEvents();
            this.updateDocSelect();
            this.updateDocumentView();
        }

        bindEvents() {
            this.mainTextArea.addEventListener('mouseup', (e) => this.handleSelection(e));
            this.mainTextArea.addEventListener('input', () => this.updateCharCount());
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.marker') && !e.target.closest('#mini-palette')) { this.clearAllReveals(); }
                if (!this.miniPalette.contains(e.target) && !this.mainTextArea.contains(e.target)) { this.hideMiniPalette(); }
            });
            this.mainTextArea.addEventListener('click', (e) => this.handleMarkerClick(e));
            this.docSelect.addEventListener('change', (e) => this.switchDocument(parseInt(e.target.value, 10)));
            this.renameDocBtn.addEventListener('click', () => this.renameDocument());
            this.managerHeader.addEventListener('click', (e) => {
                 if (e.target.closest('.panel-header-controls')) return;
                 this.toggleManagerPanel();
            });
            this.copyTextBtn.addEventListener('click', () => this.copyPlainText());
            this.syncBtn.addEventListener('click', () => this.openSyncModal());
            this.toggleMarkersCb.addEventListener('change', (e) => this.toggleAllMarkersVisibility(e.target.checked));
            this.copyRulesBtn.addEventListener('click', () => this.copyCurrentDocRules());
            this.importRulesBtn.addEventListener('click', () => this.importCurrentDocRules());
            this.speechBtn.addEventListener('click', () => this.toggleSpeech());
            this.exportChoiceBtn.addEventListener('click', () => this.setupExportModal());
            this.importChoiceBtn.addEventListener('click', () => this.setupImportModal());
            this.closeModalBtn.addEventListener('click', () => this.closeSyncModal());
            this.ioActionBtn.addEventListener('click', () => this.handleIoAction());
        }

        createMiniPalette() {
            this.markerStyles.forEach(style => {
                const item = document.createElement('div');
                item.className = 'mini-palette-item';
                item.textContent = style.value;
                item.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    this.createMarkerFromPalette(style);
                });
                this.miniPalette.appendChild(item);
            });
        }
        
        handleSelection(e) {
            const selection = window.getSelection();
            if (!selection.rangeCount || selection.isCollapsed || !selection.toString().trim()) {
                this.hideMiniPalette(); return;
            }
            this.state.selectionRange = selection.getRangeAt(0).cloneRange();
            const rect = this.state.selectionRange.getBoundingClientRect();
            this.showMiniPalette(rect.left + window.scrollX, rect.top + window.scrollY);
        }

        showMiniPalette(x, y) {
            this.miniPalette.style.display = 'flex';
            this.miniPalette.style.left = `${x}px`;
            this.miniPalette.style.top = `${y - 60}px`;
        }
        
        hideMiniPalette() {
            this.miniPalette.style.display = 'none';
            this.state.selectionRange = null;
        }

        handleMarkerClick(e) {
            const marker = e.target.closest('.marker');
            if (!marker) return;

            const now = Date.now();
            if (now - this.state.lastTapTime < 300 && this.state.lastTapTarget === marker) {
                this.removeRule(marker.dataset.fullRule);
                this.state.lastTapTime = 0;
                this.state.lastTapTarget = null;
            } else {
                this.toggleMarkerReveal(marker);
                this.state.lastTapTime = now;
                this.state.lastTapTarget = marker;
            }
        }

        toggleMarkerReveal(marker) {
            if (marker.classList.contains('reveal')) {
                this.unrevealMarker(marker);
            } else {
                this.clearAllReveals();
                this.revealMarker(marker);
            }
        }

        revealMarker(marker) {
            marker.classList.add('reveal');
            marker.textContent = marker.dataset.originalText;
        }

        unrevealMarker(marker) {
            marker.classList.remove('reveal');
            const style = marker.dataset.style;
            if (style && style.startsWith('E')) {
                 marker.textContent = style.substring(1).repeat(marker.dataset.originalText.length);
            }
        }

        clearAllReveals() {
            this.mainTextArea.querySelectorAll('.marker.reveal').forEach(m => this.unrevealMarker(m));
        }

        toggleAllMarkersVisibility(show) {
            this.mainContainer.classList.toggle('markers-hidden', !show);
        }

        copyCurrentDocRules() {
            const allRules = this.state.appData.rules.split('\n').filter(Boolean);
            const targetRules = allRules.filter(rule => rule.startsWith(this.state.currentDocIndex + ' ::'));
            if (targetRules.length === 0) {
                alert("„Åì„ÅÆÊñáÁ´†„Å´„ÅØ„Éû„Éº„Ç´„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
                return;
            }
            navigator.clipboard.writeText(targetRules.join('\n')).then(() => {
                alert("„Åì„ÅÆÊñáÁ´†„ÅÆ„Éû„Éº„Ç´„Éº„É´„Éº„É´„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ");
            });
        }

        importCurrentDocRules() {
            const pastedRules = prompt("„Åì„Åì„Å´„ÄÅ„Ç≥„Éî„Éº„Åó„Åü„Éû„Éº„Ç´„Éº„É´„Éº„É´„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\nÊ≥®ÊÑèÔºö„Åì„ÅÆÊñáÁ´†„ÅÆÊó¢Â≠ò„ÅÆ„Éû„Éº„Ç´„Éº„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ");
            if (pastedRules === null) return;

            const otherDocsRules = this.state.appData.rules.split('\n').filter(Boolean)
                .filter(rule => !rule.startsWith(this.state.currentDocIndex + ' ::'));
            
            const newRules = pastedRules.split('\n').filter(Boolean);
            const isValid = newRules.every(rule => rule.startsWith(this.state.currentDocIndex + ' ::'));

            if (!isValid) {
                alert("„Ç®„É©„ÉºÔºöË≤º„Çä‰ªò„Åë„Çâ„Çå„Åü„Éá„Éº„Çø„ÅØ„ÄÅ„Åì„ÅÆÊñáÁ´†Áî®„ÅÆ„É´„Éº„É´„Åß„ÅØ„Å™„ÅÑ„Çà„ÅÜ„Åß„Åô„ÄÇ");
                return;
            }

            this.state.appData.rules = [...otherDocsRules, ...newRules].join('\n');
            this.applyRules();
        }

        applyRules() {
            const originalText = this.getOriginalText();
            this.state.appData.documents[this.state.currentDocIndex].content = originalText;
            this.mainTextArea.innerHTML = '';
            
            let segments = [{ text: originalText, type: 'text' }];
            const allRules = this.state.appData.rules.split('\n').filter(Boolean);
            const targetRules = allRules.filter(rule => rule.startsWith(this.state.currentDocIndex + ' ::'));
            
            targetRules.forEach(rule => {
                try {
                    const ruleParts = rule.split(' -> ');
                    const hiddenTextAndStyle = ruleParts[1].split(' %% ');
                    const hiddenText = hiddenTextAndStyle[0];
                    const styleString = hiddenTextAndStyle[1];
                    const anchorParts = ruleParts[0].split(' :: ')[1].split('...');
                    const prefix = anchorParts[0];
                    const suffix = anchorParts[1];
                    const fullAnchor = prefix + hiddenText + suffix;
                    
                    for (let i = 0; i < segments.length; i++) {
                        if (segments[i].type === 'text') {
                            const index = segments[i].text.indexOf(fullAnchor);
                            if (index > -1) {
                                const before = segments[i].text.substring(0, index + prefix.length);
                                const after = segments[i].text.substring(index + prefix.length + hiddenText.length);
                                segments.splice(i, 1, { text: before, type: 'text' }, { text: hiddenText, type: 'marker', style: styleString, fullRule: rule }, { text: after, type: 'text' });
                                break;
                            }
                        }
                    }
                } catch(e) {}
            });

            segments.forEach(seg => {
                if (seg.type === 'text') {
                    this.mainTextArea.appendChild(document.createTextNode(seg.text));
                } else if(seg.type === 'marker') {
                    const markerSpan = document.createElement('span');
                    markerSpan.className = 'marker';
                    markerSpan.dataset.originalText = seg.text;
                    markerSpan.dataset.style = seg.style;
                    markerSpan.dataset.fullRule = seg.fullRule;
                    const type = seg.style.charAt(0);
                    const value = seg.style.substring(1);
                    if (type === 'E') { markerSpan.textContent = value.repeat(seg.text.length); }
                    this.mainTextArea.appendChild(markerSpan);
                }
            });

            this.mainTextArea.innerHTML = this.mainTextArea.innerHTML.replace(/\n/g, '<br>');
            this.renderMarkerManager();
            this.updateCharCount();
            this.saveState();
        }

        renderMarkerManager() {
            this.markerManagerList.innerHTML = '';
            const allRules = this.state.appData.rules.split('\n').filter(Boolean);
            const targetRules = allRules.filter(rule => rule.startsWith(this.state.currentDocIndex + ' ::'));

            if(targetRules.length === 0) {
                this.markerManagerList.innerHTML = '<p style="text-align:center; color:#718096; padding: 20px;">„Éû„Éº„Ç´„Éº„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
                return;
            }

            targetRules.forEach(rule => {
                const item = document.createElement('div');
                item.className = 'manager-item';
                item.dataset.fullRule = rule;
                const ruleParts = rule.split(' -> ');
                const hiddenTextAndStyle = ruleParts[1].split(' %% ');
                const hiddenText = hiddenTextAndStyle[0];
                const styleString = hiddenTextAndStyle[1];
                const anchorText = ruleParts[0].split(' :: ')[1];
                const icon = styleString.substring(1);
                
                item.innerHTML = `
                    <div class="manager-item-icon">${icon}</div>
                    <div class="manager-item-details">
                        <div class="manager-item-text">${hiddenText}</div>
                        <div class="manager-item-context">${anchorText.replace('...', ' ... ')}</div>
                    </div>
                    <button class="manager-item-delete" title="„Åì„ÅÆ„Éû„Éº„Ç´„Éº„ÇíÂâäÈô§">üóëÔ∏è</button>
                `;
                item.querySelector('.manager-item-delete').addEventListener('click', (e) => { e.stopPropagation(); this.removeRule(rule); });
                item.addEventListener('click', () => this.jumpToMarker(rule));
                this.markerManagerList.appendChild(item);
            });
        }
        
        removeRule(ruleToRemove) {
            const allRules = this.state.appData.rules.split('\n');
            const index = allRules.findIndex(r => r === ruleToRemove);
            if (index > -1) {
                allRules.splice(index, 1);
                this.state.appData.rules = allRules.join('\n');
                this.applyRules();
            }
        }

        jumpToMarker(rule) {
            const markerInDom = this.mainTextArea.querySelector(`.marker[data-full-rule="${CSS.escape(rule)}"]`);
            if (markerInDom) {
                markerInDom.scrollIntoView({ behavior: 'smooth', block: 'center' });
                markerInDom.classList.remove('jump-highlight');
                void markerInDom.offsetWidth;
                markerInDom.classList.add('jump-highlight');
            }
        }
        
        copyPlainText() {
            const text = this.getOriginalText();
            navigator.clipboard.writeText(text).then(() => { alert("ÂéüÊñá„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ"); });
        }
        
        openSyncModal() {
            this.modalOverlay.style.display = 'flex';
            this.modalTitle.textContent = "ÂÖ®„Éá„Éº„ÇøÂêåÊúü";
            this.modalChoices.style.display = 'flex';
            this.modalDesc.innerHTML = '';
            this.ioTextarea.style.display = 'none';
            this.ioActionBtn.style.display = 'none';
        }

        setupExportModal() {
            this.modalChoices.style.display = 'none';
            this.modalDesc.innerHTML = '<strong>„Åì„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Åå„ÅÇ„Å™„Åü„ÅÆÂÖ®„Éá„Éº„Çø„Åß„Åô„ÄÇ</strong><br>„Åì„Çå„ÇíÂÖ®„Å¶„Ç≥„Éî„Éº„Åó„ÄÅÂÆâÂÖ®„Å™Â†¥ÊâÄ„Å´‰øùÁÆ°„Åô„Çã„Åã„ÄÅ‰ªñ„ÅÆ„Éá„Éê„Ç§„Çπ„Åß„Ç§„É≥„Éù„Éº„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
            this.ioTextarea.value = JSON.stringify(this.state.appData, null, 2);
            this.ioTextarea.readOnly = true;
            this.ioTextarea.style.display = 'block';
            this.ioActionBtn.textContent = "„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº";
            this.ioActionBtn.style.display = 'block';
        }
        
        setupImportModal() {
            this.modalChoices.style.display = 'none';
            this.modalDesc.innerHTML = '<strong>Ê≥®ÊÑèÔºöÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ</strong><br>„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åó„Åü„Éá„Éº„Çø„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„ÄÅ„ÄåË™≠„ÅøËæº„ÇÄ„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
            this.ioTextarea.value = '';
            this.ioTextarea.readOnly = false;
            this.ioTextarea.style.display = 'block';
            this.ioActionBtn.textContent = "„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÄ";
            this.ioActionBtn.style.display = 'block';
        }

        closeSyncModal() { this.modalOverlay.style.display = 'none'; }
        
        handleIoAction() {
            if (this.ioActionBtn.textContent.includes('„Ç≥„Éî„Éº')) {
                navigator.clipboard.writeText(this.ioTextarea.value).then(() => {
                    this.ioActionBtn.textContent = "„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ";
                    setTimeout(() => this.ioActionBtn.textContent = "„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº", 2000);
                });
            } else {
                if(!confirm("Êú¨ÂΩì„Å´ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Çí‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ")) return;
                try {
                    const newData = JSON.parse(this.ioTextarea.value);
                    if (newData.documents && Array.isArray(newData.documents) && typeof newData.rules === 'string') {
                        this.state.appData = newData;
                        this.state.currentDocIndex = 0;
                        this.saveState();
                        this.updateDocSelect();
                        this.updateDocumentView();
                        this.closeSyncModal();
                        alert("„Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü„ÄÇ");
                    } else { throw new Error("Invalid data structure"); }
                } catch (e) { alert("„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ"); }
            }
        }
        
        renameDocument() {
            const currentTitle = this.state.appData.documents[this.state.currentDocIndex].title;
            const newTitle = prompt("Êñ∞„Åó„ÅÑ„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:", currentTitle);
            if (newTitle && newTitle.trim()) {
                this.state.appData.documents[this.state.currentDocIndex].title = newTitle.trim();
                this.updateDocSelect();
                this.saveState();
            }
        }
        
        updateCharCount() {
            const count = this.getOriginalText().length;
            this.charCounter.textContent = `ÊñáÂ≠óÊï∞: ${count}`;
        }
        
        updateDocSelect() {
            this.docSelect.innerHTML = '';
            this.state.appData.documents.forEach((doc, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = doc.title;
                this.docSelect.appendChild(option);
            });
            this.docSelect.value = this.state.currentDocIndex;
        }

        switchDocument(docIndex) {
            this.state.appData.documents[this.state.currentDocIndex].content = this.getOriginalText();
            this.state.currentDocIndex = docIndex;
            this.updateDocumentView();
        }

        updateDocumentView() {
            this.docSelect.value = this.state.currentDocIndex;
            const currentDoc = this.state.appData.documents[this.state.currentDocIndex];
            this.mainTextArea.textContent = currentDoc.content;
            this.applyRules();
        }
        
        getOriginalText() {
            const tempDiv = document.createElement('div');
            this.mainTextArea.childNodes.forEach(node => {
                if (node.nodeType === Node.TEXT_NODE) {
                    tempDiv.appendChild(node.cloneNode());
                } else if (node.nodeName === 'SPAN' && node.classList.contains('marker')) {
                    tempDiv.appendChild(document.createTextNode(node.dataset.originalText));
                } else if (node.nodeName === 'BR') {
                    tempDiv.appendChild(document.createTextNode('\n'));
                }
            });
            return tempDiv.textContent || '';
        }

        saveState() {
            if (this.state.appData.documents[this.state.currentDocIndex]) {
                 this.state.appData.documents[this.state.currentDocIndex].content = this.getOriginalText();
            }
            localStorage.setItem('markerToolState_v3_2', JSON.stringify(this.state.appData));
        }

        loadState() {
            const savedState = localStorage.getItem('markerToolState_v3_2');
            if (savedState) {
                try {
                    const data = JSON.parse(savedState);
                    if (data.documents && Array.isArray(data.documents)) {
                        this.state.appData = data;
                    } else { this.resetData(); }
                } catch(e) { this.resetData(); }
            } else { this.resetData(); }

            while(this.state.appData.documents.length < this.DOC_COUNT) {
                const newIndex = this.state.appData.documents.length + 1;
                this.state.appData.documents.push({ title: `ÊñáÁ´† ${newIndex}`, content: `` });
            }
            this.state.appData.documents = this.state.appData.documents.slice(0, this.DOC_COUNT);
        }

        resetData() {
            this.state.appData = { documents: [], rules: '' };
            for(let i=1; i<=this.DOC_COUNT; i++) {
                this.state.appData.documents.push({ title: `ÊñáÁ´† ${i}`, content: `` });
            }
        }
        
        toggleManagerPanel() { this.managerPanel.classList.toggle('closed'); this.toggleManagerBtn.textContent = this.managerPanel.classList.contains('closed') ? '‚ñ≤ Èñã„Åè' : '‚ñº Èñâ„Åò„Çã'; }

        initSpeech() {
            if (!('speechSynthesis' in window)) {
                this.speechBtn.disabled = true; this.speechBtn.textContent = "Ë™≠‰∏ä‰∏çÂèØ"; return;
            }
            const loadVoices = () => {
                this.state.voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('ja'));
                if(this.state.voices.length > 0) {
                    this.voiceSelect.style.display = 'inline-block';
                    this.voiceSelect.innerHTML = '';
                    this.state.voices.forEach(v => {
                        const option = document.createElement('option');
                        option.textContent = v.name; this.voiceSelect.appendChild(option);
                    });
                } else { this.voiceSelect.style.display = 'none'; }
            };
            speechSynthesis.onvoiceschanged = loadVoices; loadVoices();
        }

        toggleSpeech() {
            if (speechSynthesis.speaking) { speechSynthesis.cancel(); return; }
            const textToSpeak = this.getOriginalText();
            if (!textToSpeak.trim()) return;
            const utterance = new SpeechSynthesisUtterterance(textToSpeak);
            const voice = this.state.voices.find(v => v.name === this.voiceSelect.value);
            if (voice) utterance.voice = voice;
            utterance.onstart = () => { this.state.isSpeaking = true; this.speechBtn.textContent = "‚èπ ÂÅúÊ≠¢"; };
            utterance.onend = () => { this.state.isSpeaking = false; this.speechBtn.textContent = "‚ñ∂ Ë™≠„Åø‰∏ä„Åí"; this.clearHighlight(); };
            utterance.onerror = () => { this.state.isSpeaking = false; this.speechBtn.textContent = "‚ñ∂ Ë™≠„Åø‰∏ä„Åí"; this.clearHighlight(); };
            utterance.onboundary = (e) => { if (e.name === 'word') this.highlightText(e.charIndex, e.charLength); };
            speechSynthesis.speak(utterance);
        }

        highlightText(start, length) {
            this.clearHighlight();
            let charCount = 0;
            const treeWalker = document.createTreeWalker(this.mainTextArea, Node.TEXT_NODE);
            while(let node = treeWalker.nextNode()) {
                const textLength = node.textContent.length;
                if (charCount + textLength >= start) {
                    const range = document.createRange();
                    const startIndexInNode = Math.max(0, start - charCount);
                    const endIndexInNode = Math.min(startIndexInNode + length, textLength);
                    if (startIndexInNode >= endIndexInNode) continue;
                    range.setStart(node, startIndexInNode);
                    range.setEnd(node, endIndexInNode);
                    const wrapper = document.createElement('span');
                    wrapper.className = 'speech-highlight';
                    try { range.surroundContents(wrapper); } catch (e) {}
                    break;
                }
                charCount += textLength;
            }
        }
        
        clearHighlight() {
            const highlighted = this.mainTextArea.querySelector('.speech-highlight');
            if (highlighted) {
                const parent = highlighted.parentNode;
                while (highlighted.firstChild) parent.insertBefore(highlighted.firstChild, highlighted);
                parent.removeChild(highlighted);
                parent.normalize();
            }
        }
    }
    new MarkerToolV3_2();
    </script>
</body>
</html>
